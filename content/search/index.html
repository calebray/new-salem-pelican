<!DOCTYPE html>
<html>
    <head>
        <title>Search the Salem Witchcraft Papers</title>
        <link rel="stylesheet" href="/style.css">
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
<script src="https://unpkg.com/lunr/lunr.js" type="text/javascript" charset="utf-8"></script>
    <script>
jQuery(function() {

    $.getJSON('/search/idx.json', function(data, err) {
        window.idx = data;
    });

    $.getJSON('/search/corpus.json', function(data, err) {
        window.documents = [];
        Object.entries(data).forEach(function(key, value) {
            var doc = {
                'id': key[1].id,
                'content': key[1].content,
                'title': key[1].title,
                'slug': key[1].slug,
            };
            window.documents.push(doc);
        });
    });
    // Event when the form is submitted

    $("#search-input").on('change', function(event) {
        event.preventDefault();
        var query = $("#search-input").val(); // the value for the text field
        window.index = lunr.Index.load(window.idx);
        var results = window.index.search(query);
        // Get lunr to perform a search
        display_search_results(results); // Hand the results off to be displayed
    });
    var searchSettings = false;

    var buildSearchResult = function(doc) {
        console.log(doc);
        var div = document.createElement('div'),
            article = document.createElement('article'),
            header = document.createElement('header'),
            section = document.createElement('section'),
            h2 = document.createElement('h2'),
            a = document.createElement('a'),
            p1 = document.createElement('p')

        a.dataset.field = 'name';
        a.href += '/' + doc.slug + '.html';
        a.textContent = doc.title.toUpperCase();

        p1.dataset.field = 'content';
        p1.textContent = doc.content;
        p1.style.textOverflow = 'ellipsis';
        p1.style.overflow = 'hidden';
        p1.style.whiteSpace = 'nowrap';
        
        div.class = 'doc';
        div.appendChild(article);
        article.appendChild(header);
        article.appendChild(section);
        header.appendChild(h2);
        h2.appendChild(a);
        section.appendChild(p1);

        return div;
    }

        function display_search_results(results) {
            var search_results = $("#search-list");
            if (results.length) {
                search_results.empty(); // Clear any old results

                results.forEach(function(result) {
                    var item = window.documents.filter(doc => doc.id === result.ref);
                    var li = buildSearchResult(item[0]) // Build a snippet of HTML for this result
                    Object.keys(result.matchData.metadata).forEach(function(term) {
                        Object.keys(result.matchData.metadata[term]).forEach(function(fieldName) {
                            var field = li.querySelector('[data-field=' + fieldName + ']'),
                                positions = result.matchData.metadata[term][fieldName].position
                                wrapTerms(field, positions);
                        });
                    });
                    search_results.append(li);
                });

                searchSettings = false;
            } else {
                // If there are no results, let the user know.
                search_results.html('<li>No results found.<br/>Please check spelling, spacing, yada...</li>');
                searchSettings = false;
            }

        }

    function wrapTerms(element, matches) {
        var nodeFilter = {
            acceptNode: function(node) {
                if (/^[\t\n\r ]*$/.test(node.nodeValue)) {
                    return NodeFilter.FILTER_SKIP
                }
                return NodeFilter.FILTER_ACCEPT
            }
        }
        var index = 0,
            matches = matches.sort(function(a, b) {
                return a[0] - b[0]
            }).slice(),
            previousMatch = [-2, - 2],
            match = matches.shift(),
            walker
        if (element instanceof Element) {
            walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            nodeFilter,
            false)
        } else {
            return 'not an element';
        }
        while (node = walker.nextNode()) {
            if (match == undefined) break
            if (match[0] == previousMatch[0]) continue

            var text = node.textContent,
                nodeEndIndex = index + node.length;

            if (match[0] < nodeEndIndex) {
                var range = document.createRange(),
                    tag = document.createElement('mark'),
                    rangeStart = match[0] - index,
                    rangeEnd = rangeStart + match[1];

                tag.dataset.rangeStart = rangeStart
                tag.dataset.rangeEnd = rangeEnd

                range.setStart(node, rangeStart)
                range.setEnd(node, rangeEnd)
                range.surroundContents(tag)

                index = match[0] + match[1]

                // the next node will now actually be the text we just wrapped, so
                // we need to skip it
                walker.nextNode()
                previousMatch = match
                match = matches.shift()
            } else {
                index = nodeEndIndex
            }
        }
    }
});
</script>

</head>
<body topmargin="0" leftmargin="0" bgcolor="#FFFFFF" link="#000099" marginheight="0" marginwidth="0" text="#000000" vlink="#006633">
	<div class="header nosearchhi">
		<img src="/images/start2b.jpg" width="621" height="90" border="1" />
		<ul class="menu">
			<li class="menu_item menu_home" style="width:13%;">
                <a href="/home.html" shape="rect">Home</a>
			</li>
			<li class="menu_item menu_archives" style="width:15%">
				<a href="/archive2.html" shape="rect">Archives</a>
			</li>
			<li class="menu_item menu_books" style="width:24%;">
				<a href="/books.html" shape="rect">Books &amp; Letters</a>
			</li>
			<li class="menu_item menu_documents" style="width:20%;">
				<a href="/17docs.html" shape="rect">Documents</a>
			</li>
			<li class="menu_item menu_maps" style="width:13%;">
				<a href="/maps.html" shape="rect">Maps</a>
			</li>
			<li class="menu_item menu_people" style="width:15%;">
				<a href="/people?group.num=all" shape="rect">People</a>
			</li>
		</ul>
	</div>
<div class="content_container">
    <div class="search_content" style="overflow:hidden;">
        <h1>Search the Salem Witchcraft Papers</h1>
        <form id="search_form">
        <label for="search-input">Search for word or phrase:</label> <input type="search" name="search-input" id="search-input">
        </form>
        <div id="search">
            <div class="docs" id="search-list"></div>
        </div>
    </div>
</div>
</body>
</html>

