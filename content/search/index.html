<!DOCTYPE html>
<html>
    <head>
        <title>Search the Salem Witchcraft Papers</title>
        <link rel="stylesheet" href="/style.css">
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
<script src="https://unpkg.com/lunr/lunr.js" type="text/javascript" charset="utf-8"></script>
    <script>
jQuery(function() {

    $.getJSON('/search/idx.json', function(data, err) {
        window.idx = data;
    });

    $.getJSON('/search/corpus.json', function(data, err) {
        window.documents = [];
        Object.entries(data).forEach(function(key, value) {
            var doc = {
                'id': key[1].id,
                'content': key[1].content,
                'title': key[1].title,
                'slug': key[1].slug,
                'date': key[1].date,
                'year': key[1].year,
                'month': key[1].month,
                'day': key[1].day,
                'case_id': key[1].case_id,
                'case_title': key[1].case_title
            };
            window.documents.push(doc);
        });
    });

    // Event when the form is submitted
    $("#search_button").on('click', function(event) {
        event.preventDefault();
        var query,
            terms = $("#search-input").val(),
            queryArray = new Array(),
            year = $('#year').val(),
            month = $('#month').val()
            day = $('#day').val();

        // UGH
        if (year) {
            yearquery = '+year:'+year;
            queryArray.push(yearquery);
            if (month) {
                monthquery = '+month:'+month;
                queryArray.push(monthquery);
                if (day) {
                    dayquery = '+day:'+day;
                    queryArray.push(dayquery);
                }
            }
        }
        if(terms) {
            termsArray = terms.split(' ');
            termsQuery = '+'+termsArray.join(' +');
            queryArray.push(termsQuery);
        }
        query = queryArray.join(' ');
        console.log(query);        
        window.index = lunr.Index.load(window.idx);
        var results = window.index.search(query);
        // Get lunr to perform a search
        display_search_results(results); // Hand the results off to be displayed
    });
    var searchSettings = false;

    var buildSearchResult = function(doc) {
        console.log(doc);
        var div = document.createElement('div'),
            article = document.createElement('article'),
            header = document.createElement('header'),
            section = document.createElement('section'),
            em = document.createElement('em'),
            h2 = document.createElement('h2'),
            courtcase = document.createElement('p'),
            a = document.createElement('a'),
            p1 = document.createElement('p')

        em.textContent = doc.date;
        a.dataset.field = 'name';
        a.href += '/' + doc.slug + '.html#'+doc.id;
        a.textContent = doc.title.toUpperCase();
        courtcase.textContent = 'Case: ' + doc.case_title;
        p1.dataset.field = 'content';
        p1.textContent = doc.content;
        p1.style.textOverflow = 'ellipsis';
        p1.style.overflow = 'hidden';
        p1.style.whiteSpace = 'nowrap';
        
        div.class = 'doc';
        div.appendChild(article);
        article.appendChild(header);
        article.appendChild(section);
        header.appendChild(em);
        header.appendChild(h2);
        header.appendChild(courtcase);
        h2.appendChild(a);
        section.appendChild(p1);

        return div;
    }

        function display_search_results(results) {
            var search_results = $("#search-list");
            if (results.length) {
                search_results.empty(); // Clear any old results

                results.forEach(function(result) {
                    var item = window.documents.filter(doc => doc.id === result.ref);
                    var li = buildSearchResult(item[0]) // Build a snippet of HTML for this result
                    Object.keys(result.matchData.metadata).forEach(function(term) {
                        Object.keys(result.matchData.metadata[term]).forEach(function(fieldName) {
                            var field = li.querySelector('[data-field=' + fieldName + ']'),
                                positions = result.matchData.metadata[term][fieldName].position
                                wrapTerms(field, positions);
                        });
                    });
                    search_results.append(li);
                });

                searchSettings = false;
            } else {
                // If there are no results, let the user know.
                search_results.html('<li>No results found.<br/>Please check spelling, spacing, yada...</li>');
                searchSettings = false;
            }

        }

    function wrapTerms(element, matches) {
        var nodeFilter = {
            acceptNode: function(node) {
                if (/^[\t\n\r ]*$/.test(node.nodeValue)) {
                    return NodeFilter.FILTER_SKIP
                }
                return NodeFilter.FILTER_ACCEPT
            }
        }
        var index = 0,
            matches = matches.sort(function(a, b) {
                return a[0] - b[0]
            }).slice(),
            previousMatch = [-2, - 2],
            match = matches.shift(),
            walker
        if (element instanceof Element) {
            walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            nodeFilter,
            false)
        } else {
            return 'not an element';
        }
        while (node = walker.nextNode()) {
            if (match == undefined) break
            if (match[0] == previousMatch[0]) continue

            var text = node.textContent,
                nodeEndIndex = index + node.length;

            if (match[0] < nodeEndIndex) {
                var range = document.createRange(),
                    tag = document.createElement('mark'),
                    rangeStart = match[0] - index,
                    rangeEnd = rangeStart + match[1];

                tag.dataset.rangeStart = rangeStart
                tag.dataset.rangeEnd = rangeEnd

                range.setStart(node, rangeStart)
                range.setEnd(node, rangeEnd)
                range.surroundContents(tag)

                index = match[0] + match[1]

                // the next node will now actually be the text we just wrapped, so
                // we need to skip it
                walker.nextNode()
                previousMatch = match
                match = matches.shift()
            } else {
                index = nodeEndIndex
            }
        }
    }
});
</script>

</head>
<body topmargin="0" leftmargin="0" bgcolor="#FFFFFF" link="#000099" marginheight="0" marginwidth="0" text="#000000" vlink="#006633">
	<div class="header nosearchhi">
		<img src="/images/start2b.jpg" width="621" height="90" border="1" />
		<ul class="menu">
			<li class="menu_item menu_home" style="width:13%;">
                <a href="/home.html" shape="rect">Home</a>
			</li>
			<li class="menu_item menu_archives" style="width:15%">
				<a href="/archive2.html" shape="rect">Archives</a>
			</li>
			<li class="menu_item menu_books" style="width:24%;">
				<a href="/books.html" shape="rect">Books &amp; Letters</a>
			</li>
			<li class="menu_item menu_documents" style="width:20%;">
				<a href="/17docs.html" shape="rect">Documents</a>
			</li>
			<li class="menu_item menu_maps" style="width:13%;">
				<a href="/maps.html" shape="rect">Maps</a>
			</li>
			<li class="menu_item menu_people" style="width:15%;">
				<a href="/people?group.num=all" shape="rect">People</a>
			</li>
		</ul>
	</div>
<div class="content_container">
    <div class="search_content" style="overflow:hidden;">
        <h1>Search the Salem Witchcraft Papers</h1>
        <form id="search_form" action="/search/">
            <label for="search-input">Search for word or phrase:</label> <input type="search" name="search-input" id="search-input"><br>
            and/or documents dated (1692/1693, excluding some undated items)<br>
            year
        <select id="year">
            <option value="">any</option>
            <option value="1692">1692</option>
            <option value="1693">1693</option>
            <option value="1696">1696</option>
            <option value="1697">1697</option>
            <option value="1702">1702</option>
            <option value="1703">1703</option>
            <option value="1709">1709</option>
            <option value="1710">1710</option>
            <option value="1711">1711</option>
            <option value="1712">1712</option>
            <option value="1713">1713</option>
            <option value="1717">1717</option>
            <option value="1718">1718</option>
            <option value="1750">1750</option>
        </select>
        month
        <select id="month">
            <option value="">any</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>
        day
        <select id="day"><option value="">any</option><option>01</option><option>02</option><option>03</option><option>04</option><option>05</option><option>06</option><option>07</option><option>08</option><option>09</option><option>10</option><option>11</option><option>12</option><option>13</option><option>14</option><option>15</option><option>16</option><option>17</option><option>18</option><option>19</option><option>20</option><option>21</option><option>22</option><option>23</option><option>24</option><option>25</option><option>26</option><option>27</option><option>28</option><option>29</option><option>30</option><option>31</option></select><br>
        <input type="submit" value="Search" id="search_button">
        <input type="button" value="Clear Results">
        </form>
        <div id="search">
            <div class="docs" id="search-list"></div>
        </div>
    </div>
</div>
</body>
</html>

